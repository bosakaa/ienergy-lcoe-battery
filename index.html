<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор LCOE для BESS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0f0f0;
        }
        .win-card {
            background-color: #ffffff;
            border: 1px solid #d0d0d0;
        }
        .input-group { margin-bottom: 1rem; }
        .input-label { display: flex; align-items: center; margin-bottom: 0.5rem; font-weight: 400; color: #333; font-size: 14px;}
        .input-field, .select-field {
            width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #8a8a8a;
            background-color: white; transition: border-color 0.2s; border-radius: 0;
        }
        .input-field:focus, .select-field:focus {
            outline: none; border-color: #0078d4; box-shadow: 0 0 0 1px #0078d4;
        }
        .unit { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: #555; pointer-events: none; }
        .result-table { width: 100%; border-collapse: collapse; }
        .result-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #e0e0e0; }
        .result-table td:first-child { font-weight: 400; color: #333; display: flex; align-items: center;}
        .result-table td:last-child { font-weight: 600; text-align: right; color: #000; }
        .result-table tr:last-child td { border-bottom: none; }
        
        .win-button {
            background-color: #e1e1e1; border: 1px solid #adadad; color: #000;
            font-weight: 400; padding: 0.5rem 2rem; transition: background-color 0.2s, border-color 0.2s; border-radius: 0;
        }
        .win-button:hover { background-color: #e5f1fb; border-color: #0078d4; }
        .win-button-primary { background-color: #0078d4; border-color: #005a9e; color: #fff; }
        .win-button-primary:hover { background-color: #106ebe; border-color: #005a9e; }

        .tooltip-container { position: relative; display: inline-block; margin-left: 8px; }
        .tooltip-icon {
            width: 16px; height: 16px; border-radius: 50%; background-color: #777;
            color: white; font-size: 12px; font-weight: bold; display: flex;
            align-items: center; justify-content: center; cursor: help;
        }
        .tooltip-text {
            visibility: hidden; width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 2px; padding: 8px; position: absolute;
            z-index: 10; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0;
            transition: opacity 0.3s; font-size: 12px; font-weight: 400;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* Navigation Styles */
        #side-menu {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        #side-menu.open {
            transform: translateX(0);
        }
        .formula-item {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
        }
        .formula-item:last-child {
            border-bottom: none;
        }
        .formula-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #005a9e;
        }
        .formula-explanation {
            font-size: 0.9rem;
            color: #333;
            margin-top: 0.5rem;
        }
        .formula-math {
            font-family: 'Courier New', Courier, monospace;
            background-color: #f0f0f0;
            padding: 0.5rem;
            margin-top: 0.5rem;
            display: block;
            white-space: pre-wrap;
            font-size: 14px;
        }
    </style>
</head>
<body class="text-gray-900">
    <!-- Side Menu -->
    <div id="side-menu" class="fixed top-0 left-0 h-full w-64 bg-gray-800 text-white z-20 shadow-lg">
        <div class="p-4">
            <h2 class="text-xl font-semibold">Меню</h2>
        </div>
        <nav>
            <a href="#" data-target="calculator-page" class="nav-link block py-2.5 px-4 hover:bg-gray-700">Калькулятор</a>
            <a href="#" data-target="formulas-page" class="nav-link block py-2.5 px-4 hover:bg-gray-700">Формули</a>
            <a href="#" data-target="contacts-page" class="nav-link block py-2.5 px-4 hover:bg-gray-700">Контакти</a>
        </nav>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <header class="text-left mb-6 flex items-center">
            <button id="menu-toggle" class="p-2 mr-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <div>
                <p class="text-sm text-gray-600">Інститут загальної енергетики НАН України</p>
                <h1 class="text-3xl font-light text-gray-900 mt-1">Калькулятор LCOE для BESS</h1>
            </div>
        </header>

        <!-- Main Content Area -->
        <main>
            <!-- Calculator Page -->
            <div id="calculator-page" class="page-content win-card p-6 sm:p-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Technical Parameters -->
                    <section>
                        <h2 class="text-xl font-light mb-4 border-b border-gray-300 pb-2">Технічні параметри</h2>
                        <div class="input-group">
                            <label for="batteryType" class="input-label">Тип батареї <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Оберіть хімію акумулятора. Це автоматично оновить типові значення ККД та деградації.</span></span></label>
                            <select id="batteryType" class="select-field">
                                <option value="nmc">NMC (Збалансований)</option>
                                <option value="lfp">LFP (Довговічний)</option>
                                <option value="nca">NCA (Високоенергетичний)</option>
                                <option value="lto">LTO (Надвисокий ресурс)</option>
                                <option value="na-ion">Na-ion (Перспективний)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="systemPower" class="input-label">Потужність системи <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Максимальна потужність (швидкість), з якою система може заряджатися або розряджатися.</span></span></label>
                            <div class="relative"><input type="number" id="systemPower" class="input-field pr-14" value="1"><span class="unit">МВт</span></div>
                        </div>
                        <div class="input-group">
                            <label for="systemCapacity" class="input-label">Ємність системи <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Загальна кількість енергії, яку може зберігати батарея.</span></span></label>
                            <div class="relative"><input type="number" id="systemCapacity" class="input-field pr-20" value="4"><span class="unit">МВт·год</span></div>
                        </div>
                        <div class="input-group">
                            <label for="rte" class="input-label">ККД повного циклу (RTE) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Відсоток енергії, що повертається під час розрядки, відносно енергії, витраченої на зарядку. Враховує втрати.</span></span></label>
                            <div class="relative"><input type="number" id="rte" class="input-field pr-12" value="88"><span class="unit">%</span></div>
                        </div>
                        <div class="input-group">
                            <label for="dod" class="input-label">Глибина розряду (DoD) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Відсоток від повної ємності, що використовується в кожному циклі. Менший DoD подовжує термін служби батареї.</span></span></label>
                            <div class="relative"><input type="number" id="dod" class="input-field pr-12" value="90"><span class="unit">%</span></div>
                        </div>
                        <div class="input-group">
                            <label for="cyclesPerYear" class="input-label">Кількість циклів на рік <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Очікувана кількість повних циклів заряду-розряду протягом року.</span></span></label>
                            <div class="relative"><input type="number" id="cyclesPerYear" class="input-field pr-20" value="365"><span class="unit">циклів</span></div>
                        </div>
                         <div class="input-group">
                            <label for="degradationRate" class="input-label">Річна деградація ємності <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Відсоток втрати максимальної ємності батареї щороку через зношення.</span></span></label>
                            <div class="relative"><input type="number" id="degradationRate" class="input-field pr-12" value="1.5"><span class="unit">%</span></div>
                        </div>
                    </section>
                    <section>
                        <h2 class="text-xl font-light mb-4 border-b border-gray-300 pb-2">Параметри витрат</h2>
                        <div class="input-group">
                            <label for="capex" class="input-label">Капітальні витрати (CAPEX) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Початкові інвестиційні витрати на обладнання, монтаж та введення в експлуатацію, розраховані на одиницю ємності.</span></span></label>
                            <div class="relative"><input type="number" id="capex" class="input-field pr-24" value="420"><span class="unit">$/кВт·год</span></div>
                        </div>
                        <div class="input-group">
                            <label for="omCost" class="input-label">Фіксовані витрати на O&M <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Щорічні витрати на обслуговування, моніторинг та страхування, розраховані на одиницю потужності.</span></span></label>
                            <div class="relative"><input type="number" id="omCost" class="input-field pr-24" value="12"><span class="unit">$/кВт-рік</span></div>
                        </div>
                        <div class="input-group">
                            <label for="chargingCost" class="input-label">Вартість енергії для зарядки <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Середня ціна, за якою система купує електроенергію з мережі для зарядки.</span></span></label>
                            <div class="relative"><input type="number" id="chargingCost" class="input-field pr-24" value="40"><span class="unit">$/МВт·год</span></div>
                        </div>
                        <div class="input-group">
                            <label for="replacementCost" class="input-label">Вартість заміни <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Вартість заміни акумуляторного блоку у відсотках від початкових капітальних витрат.</span></span></label>
                             <div class="relative"><input type="number" id="replacementCost" class="input-field pr-24" value="60"><span class="unit">% від CAPEX</span></div>
                        </div>
                        <div class="input-group">
                            <label for="replacementYear" class="input-label">Рік заміни <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Рік, у якому планується провести повну заміну акумуляторних модулів.</span></span></label>
                            <div class="relative"><input type="number" id="replacementYear" class="input-field pr-14" value="12"><span class="unit">Рік</span></div>
                        </div>
                    </section>
                    <section>
                        <h2 class="text-xl font-light mb-4 border-b border-gray-300 pb-2">Фінансові параметри</h2>
                        <div class="input-group">
                            <label for="ppaPrice" class="input-label">Ціна продажу (PPA), Рік 1 <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Ціна, за якою система продає 1 МВт·год енергії в перший рік роботи.</span></span></label>
                            <div class="relative"><input type="number" id="ppaPrice" class="input-field pr-24" value="250"><span class="unit">$/МВт·год</span></div>
                        </div>
                        <div class="input-group">
                            <label for="ppaEscalation" class="input-label">Індексація PPA <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Щорічне зростання ціни продажу енергії (PPA) для врахування інфляції або ринкових умов.</span></span></label>
                            <div class="relative"><input type="number" id="ppaEscalation" class="input-field pr-16" value="2"><span class="unit">% / рік</span></div>
                        </div>
                        <div class="input-group">
                            <label for="projectLifetime" class="input-label">Термін служби проєкту <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Загальний період, протягом якого проєкт буде експлуатуватися та аналізуватися.</span></span></label>
                            <div class="relative"><input type="number" id="projectLifetime" class="input-field pr-16" value="20"><span class="unit">Років</span></div>
                        </div>
                        <div class="input-group">
                            <label for="discountRate" class="input-label">Ставка дисконтування <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Норма дохідності для приведення майбутніх грошових потоків до їхньої сьогоднішньої вартості. Відображає вартість капіталу та ризики.</span></span></label>
                            <div class="relative"><input type="number" id="discountRate" class="input-field pr-12" value="7.5"><span class="unit">%</span></div>
                        </div>
                         <div class="input-group">
                            <label for="inflationRate" class="input-label">Рівень інфляції <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Середньорічний темп знецінення грошей, що використовується для розрахунку реальних (з поправкою на інфляцію) показників.</span></span></label>
                            <div class="relative"><input type="number" id="inflationRate" class="input-field pr-12" value="2.5"><span class="unit">%</span></div>
                        </div>
                    </section>
                </div>
                <div class="text-right mt-8 pt-6 border-t border-gray-300 space-x-2">
                    <button id="exportBtn" class="win-button hidden">Експортувати в Excel</button>
                    <button id="calculateBtn" class="win-button win-button-primary">Розрахувати</button>
                </div>
                <section id="results" class="mt-10 hidden">
                     <h2 class="text-2xl font-light mb-6">Результати моделювання</h2>
                     <div class="win-card p-6">
                        <table class="result-table">
                            <tbody>
                                <tr><td>Чисті капітальні витрати <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Загальна початкова вартість проєкту без урахування фінансування.</span></span></td><td id="resNetCapitalCost">$0</td></tr>
                                <tr><td>ККД повного циклу <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Ефективність системи 'туди-назад', враховуючи втрати при заряді та розряді.</span></span></td><td id="resRte">0%</td></tr>
                                <tr><td>Зарядка від мережі (Рік 1) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Загальна кількість енергії, яку система споживе з мережі для зарядки протягом першого року.</span></span></td><td id="resEnergyChargedY1">0 МВт·год</td></tr>
                                <tr><td colspan="2" class="!py-4"></td></tr>
                                <tr><td>LCOE (номінальний) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Нормована вартість енергії в номінальних доларах (без поправки на інфляцію).</span></span></td><td id="resLcoeNominal">0.00 ¢/кВт·год</td></tr>
                                <tr><td>LCOE (реальний) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Нормована вартість енергії в реальних доларах (з поправкою на інфляцію).</span></span></td><td id="resLcoeReal">0.00 ¢/кВт·год</td></tr>
                                <tr><td colspan="2" class="!py-4"></td></tr>
                                <tr><td>Ціна PPA (Рік 1) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Початкова ціна продажу електроенергії, перерахована в центах за кіловат-годину.</span></span></td><td id="resPpaY1">0.00 ¢/кВт·год</td></tr>
                                <tr><td>LPPA (номінальний) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Нормована (усереднена за весь термін) ціна продажу енергії в номінальних доларах.</span></span></td><td id="resLppaNominal">0.00 ¢/кВт·год</td></tr>
                                <tr><td>LPPA (реальний) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Нормована (усереднена за весь термін) ціна продажу енергії в реальних доларах.</span></span></td><td id="resLppaReal">0.00 ¢/кВт·год</td></tr>
                                <tr><td colspan="2" class="!py-4"></td></tr>
                                <tr><td>Чиста приведена вартість (NPV) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Різниця між дисконтованими доходами та витратами. Позитивне значення вказує на прибутковість.</span></span></td><td id="resNpv">$0</td></tr>
                                <tr><td>Внутрішня норма дохідності (IRR) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Ставка дисконтування, за якої NPV проєкту дорівнює нулю. Показує очікувану дохідність інвестицій.</span></span></td><td id="resIrr">0.00%</td></tr>
                                <tr><td>Рік досягнення IRR (окупність) <span class="tooltip-container"><span class="tooltip-icon">?</span><span class="tooltip-text">Рік, у якому дисконтовані доходи проєкту перевищують його дисконтовані витрати.</span></span></td><td id="resPaybackYear">0</td></tr>
                            </tbody>
                        </table>
                     </div>
                     <h2 class="text-2xl font-light mb-6 mt-10">Середньодобовий графік роботи (Рік 1)</h2>
                     <div class="win-card p-4">
                         <canvas id="dailyProfileChart"></canvas>
                     </div>
                </section>
            </div>

            <!-- Formulas Page -->
            <div id="formulas-page" class="page-content hidden win-card p-6 sm:p-8">
                <h2 class="text-2xl font-light mb-6">Використані формули та метрики</h2>
                
                <div class="formula-item">
                    <p class="formula-title">Чисті капітальні витрати (Net Capital Cost)</p>
                    <p class="formula-explanation">Загальні початкові інвестиції в проєкт. Розраховуються як добуток питомих капітальних витрат на загальну ємність системи.</p>
                    <code class="formula-math">CAPEX = Ємність_системи (кВт·год) * Питомі_витрати ($/кВт·год)</code>
                </div>

                <div class="formula-item">
                    <p class="formula-title">Енергія для зарядки (Рік 1)</p>
                    <p class="formula-explanation">Загальна кількість енергії, яку потрібно закупити з мережі для зарядки системи протягом першого року, з урахуванням втрат (ККД).</p>
                    <code class="formula-math">Енергія_зарядки = (Енергія_розрядки_рік_1) / ККД</code>
                </div>

                <div class="formula-item">
                    <p class="formula-title">Чиста приведена вартість (NPV)</p>
                    <p class="formula-explanation">NPV — це різниця між сьогоднішньою вартістю майбутніх доходів та сьогоднішньою вартістю витрат. Це ключовий показник прибутковості інвестицій. Проєкт вважається фінансово доцільним, якщо NPV > 0.</p>
                    <code class="formula-math">NPV = Σ [ (Доходи_t - Витрати_t) / (1 + r)^t ] - CAPEX</code>
                    <p class="formula-explanation mt-2">де 't' - рік, 'r' - ставка дисконтування.</p>
                </div>

                <div class="formula-item">
                    <p class="formula-title">Внутрішня норма дохідності (IRR)</p>
                    <p class="formula-explanation">IRR — це ставка дисконтування, за якої NPV проєкту дорівнює нулю. Вона показує очікувану річну дохідність інвестицій. Проєкт привабливий, якщо IRR вища за вартість капіталу (ставку дисконтування).</p>
                    <code class="formula-math">0 = Σ [ (Доходи_t - Витрати_t) / (1 + IRR)^t ] - CAPEX</code>
                </div>

                <div class="formula-item">
                    <p class="formula-title">Нормована вартість енергії (LCOE)</p>
                    <p class="formula-explanation">LCOE представляє середню собівартість однієї одиниці енергії (кВт·год або МВт·год) за весь життєвий цикл. Це точка беззбитковості для продажу енергії.</p>
                    <code class="formula-math">LCOE = (Сума дисконтованих витрат) / (Сума дисконтованої енергії)</code>
                </div>

                <div class="formula-item">
                    <p class="formula-title">Нормована ціна договору (LPPA)</p>
                    <p class="formula-explanation">LPPA — це середня ціна продажу однієї одиниці енергії за весь життєвий цикл, приведена до сьогоднішньої вартості.</p>
                    <code class="formula-math">LPPA = (Сума дисконтованих доходів) / (Сума дисконтованої енергії)</code>
                </div>

                <div class="formula-item">
                    <p class="formula-title">Реальна та номінальна ставка</p>
                    <p class="formula-explanation">Номінальні показники не враховують інфляцію, тоді як реальні її враховують. Реальна ставка дисконтування використовується для розрахунку реальних LCOE та LPPA.</p>
                    <code class="formula-math">РеальнаСтавка = ((1 + НомінальнаСтавка) / (1 + Інфляція)) - 1</code>
                </div>

                <div class="formula-item">
                    <p class="formula-title">Дисконтований період окупності</p>
                    <p class="formula-explanation">Рік, у якому кумулятивна (накопичена) дисконтована вартість чистих грошових потоків (доходи мінус витрати) вперше стає додатною.</p>
                </div>
            </div>

            <!-- Contacts Page -->
            <div id="contacts-page" class="page-content hidden win-card p-6 sm:p-8">
                <h2 class="text-2xl font-light mb-6">Контакти</h2>
                <p class="mb-2"><strong>Інститут загальної енергетики НАН України</strong></p>
                <p>Адреса: вул. Антоновича, 172, Київ, 03150, Україна</p>
                <p>Телефон: (096) 852-04-95</p>
                <p>Email: bosak_av@nas.gov.ua</p>
            </div>
        </main>
    </div>

    <script>
        let dailyChart = null;
        let lastInputs = null;
        let lastResults = null;

        const batteryPresets = {
            nmc: { rte: 88, degradationRate: 1.5 },
            lfp: { rte: 93, degradationRate: 1.0 },
            nca: { rte: 90, degradationRate: 1.8 },
            lto: { rte: 92, degradationRate: 0.5 },
            'na-ion': { rte: 85, degradationRate: 1.2 }
        };

        const batteryTypeSelector = document.getElementById('batteryType');
        batteryTypeSelector.addEventListener('change', (e) => {
            const preset = batteryPresets[e.target.value];
            if (preset) {
                document.getElementById('rte').value = preset.rte;
                document.getElementById('degradationRate').value = preset.degradationRate;
            }
        });

        function calculateIRR(cashflows, guess = 0.1) {
            const maxIterations = 100, precision = 1e-7;
            let rate = guess;
            for (let i = 0; i < maxIterations; i++) {
                let npv = 0, derivative = 0;
                for (let t = 0; t < cashflows.length; t++) {
                    npv += cashflows[t] / Math.pow(1 + rate, t);
                    derivative -= t * cashflows[t] / Math.pow(1 + rate, t + 1);
                }
                if (Math.abs(derivative) < 1e-10) return rate;
                const newRate = rate - npv / derivative;
                if (Math.abs(newRate - rate) < precision) return newRate;
                rate = newRate;
            }
            return rate;
        }

        document.getElementById('calculateBtn').addEventListener('click', () => {
            const inputs = {
                batteryType: document.getElementById('batteryType').options[document.getElementById('batteryType').selectedIndex].text,
                powerMW: parseFloat(document.getElementById('systemPower').value),
                capacityMWh: parseFloat(document.getElementById('systemCapacity').value),
                rte: parseFloat(document.getElementById('rte').value),
                dod: parseFloat(document.getElementById('dod').value),
                cyclesPerYear: parseInt(document.getElementById('cyclesPerYear').value),
                degradationRate: parseFloat(document.getElementById('degradationRate').value),
                capexPerKWh: parseFloat(document.getElementById('capex').value),
                omPerKWYear: parseFloat(document.getElementById('omCost').value),
                chargingCostPerMWh: parseFloat(document.getElementById('chargingCost').value),
                replacementCostPercent: parseFloat(document.getElementById('replacementCost').value),
                replacementYear: parseInt(document.getElementById('replacementYear').value),
                lifetime: parseInt(document.getElementById('projectLifetime').value),
                discountRate: parseFloat(document.getElementById('discountRate').value),
                inflationRate: parseFloat(document.getElementById('inflationRate').value),
                ppaPrice: parseFloat(document.getElementById('ppaPrice').value),
                ppaEscalation: parseFloat(document.getElementById('ppaEscalation').value),
            };
            lastInputs = inputs;

            const inputsForCalc = { ...inputs };
            inputsForCalc.rte /= 100;
            inputsForCalc.dod /= 100;
            inputsForCalc.degradationRate /= 100;
            inputsForCalc.replacementCostPercent /= 100;
            inputsForCalc.discountRate /= 100;
            inputsForCalc.inflationRate /= 100;
            inputsForCalc.ppaEscalation /= 100;

            const powerKW = inputsForCalc.powerMW * 1000;
            const capacityKWh = inputsForCalc.capacityMWh * 1000;
            const initialCapex = capacityKWh * inputsForCalc.capexPerKWh;
            const realDiscountRate = ((1 + inputsForCalc.discountRate) / (1 + inputsForCalc.inflationRate)) - 1;

            let totalDiscountedEnergyNominal = 0, totalDiscountedEnergyReal = 0;
            let totalDiscountedCostNominal = initialCapex, totalDiscountedRevenueNominal = 0;
            let currentCapacityMWh = inputsForCalc.capacityMWh;
            let energyChargedY1 = 0, cashFlows = [-initialCapex], cumulativePvCashFlow = -initialCapex, paybackYear = "N/A";

            for (let year = 1; year <= inputsForCalc.lifetime; year++) {
                if (year === inputsForCalc.replacementYear + 1) currentCapacityMWh = inputsForCalc.capacityMWh;
                const energyDischargedMWh = currentCapacityMWh * inputsForCalc.dod * inputsForCalc.cyclesPerYear;
                const energyChargedMWh = energyDischargedMWh / inputsForCalc.rte;
                if (year === 1) energyChargedY1 = energyChargedMWh;
                const costOfCharging = energyChargedMWh * inputsForCalc.chargingCostPerMWh;
                const costOM = powerKW * inputsForCalc.omPerKWYear;
                const costReplacement = (year === inputsForCalc.replacementYear) ? (initialCapex * inputsForCalc.replacementCostPercent) : 0;
                const totalAnnualCost = costOfCharging + costOM + costReplacement;
                const currentPpaPrice = inputsForCalc.ppaPrice * Math.pow(1 + inputsForCalc.ppaEscalation, year - 1);
                const annualRevenue = energyDischargedMWh * currentPpaPrice;
                const annualNetCashFlow = annualRevenue - totalAnnualCost;
                cashFlows.push(annualNetCashFlow);
                cumulativePvCashFlow += annualNetCashFlow / Math.pow(1 + inputsForCalc.discountRate, year);
                if (cumulativePvCashFlow > 0 && paybackYear === "N/A") paybackYear = year;
                const discountFactorNominal = Math.pow(1 + inputsForCalc.discountRate, year);
                const discountFactorReal = Math.pow(1 + realDiscountRate, year);
                totalDiscountedCostNominal += totalAnnualCost / discountFactorNominal;
                totalDiscountedRevenueNominal += annualRevenue / discountFactorNominal;
                totalDiscountedEnergyNominal += energyDischargedMWh / discountFactorNominal;
                totalDiscountedEnergyReal += energyDischargedMWh / discountFactorReal;
                currentCapacityMWh *= (1 - inputsForCalc.degradationRate);
            }

            const lcoeNominal = totalDiscountedCostNominal / totalDiscountedEnergyNominal;
            const lcoeReal = totalDiscountedCostNominal / totalDiscountedEnergyReal;
            const lppaNominal = totalDiscountedRevenueNominal / totalDiscountedEnergyNominal;
            const lppaReal = totalDiscountedRevenueNominal / totalDiscountedEnergyReal;
            const npv = totalDiscountedRevenueNominal - totalDiscountedCostNominal;
            const irr = calculateIRR(cashFlows);

            const formatInt = (num) => Math.round(num).toLocaleString('uk-UA');
            const toCentsPerKWh = (val) => (val / 10).toFixed(2);

            document.getElementById('resNetCapitalCost').textContent = `$${formatInt(initialCapex)}`;
            document.getElementById('resRte').textContent = `${(inputs.rte).toFixed(0)}%`;
            document.getElementById('resEnergyChargedY1').textContent = `${formatInt(energyChargedY1)} МВт·год`;
            document.getElementById('resLcoeNominal').textContent = `${toCentsPerKWh(lcoeNominal)} ¢/кВт·год`;
            document.getElementById('resLcoeReal').textContent = `${toCentsPerKWh(lcoeReal)} ¢/кВт·год`;
            document.getElementById('resPpaY1').textContent = `${toCentsPerKWh(inputs.ppaPrice)} ¢/кВт·год`;
            document.getElementById('resLppaNominal').textContent = `${toCentsPerKWh(lppaNominal)} ¢/кВт·год`;
            document.getElementById('resLppaReal').textContent = `${toCentsPerKWh(lppaReal)} ¢/кВт·год`;
            document.getElementById('resNpv').textContent = `$${formatInt(npv)}`;
            document.getElementById('resIrr').textContent = `${(irr * 100).toFixed(2)}%`;
            document.getElementById('resPaybackYear').textContent = paybackYear;
            
            lastResults = {
                netCapitalCost: `$${formatInt(initialCapex)}`, rte: `${(inputs.rte).toFixed(0)}%`, energyChargedY1: `${formatInt(energyChargedY1)} МВт·год`,
                lcoeNominal: `${toCentsPerKWh(lcoeNominal)} ¢/кВт·год`, lcoeReal: `${toCentsPerKWh(lcoeReal)} ¢/кВт·год`,
                ppaY1: `${toCentsPerKWh(inputs.ppaPrice)} ¢/кВт·год`, lppaNominal: `${toCentsPerKWh(lppaNominal)} ¢/кВт·год`,
                lppaReal: `${toCentsPerKWh(lppaReal)} ¢/кВт·год`, npv: `$${formatInt(npv)}`, irr: `${(irr * 100).toFixed(2)}%`, paybackYear: paybackYear,
            };

            updateChart(inputsForCalc);
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('exportBtn').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        });

        function updateChart(inputs) {
            const ctx = document.getElementById('dailyProfileChart').getContext('2d');
            const labels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
            const energyToDischargeMWh = inputs.capacityMWh * inputs.dod;
            const energyToChargeMWh = energyToDischargeMWh / inputs.rte;
            const dischargeDuration = 4, chargeDuration = 4;
            const dischargePower = Math.min(inputs.powerMW, energyToDischargeMWh / dischargeDuration);
            const chargePower = Math.min(inputs.powerMW, energyToChargeMWh / chargeDuration);
            const chargeData = Array(24).fill(0), dischargeData = Array(24).fill(0);
            for(let i=2; i<6; i++) chargeData[i] = chargePower;
            for(let i=18; i<22; i++) dischargeData[i] = -dischargePower;
            if (dailyChart) dailyChart.destroy();
            dailyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Споживання (Зарядка)', data: chargeData, backgroundColor: '#0078d4' },
                        { label: 'Видача (Розрядка)', data: dischargeData, backgroundColor: '#107c10' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Профіль потужності, МВт', font: { family: 'Segoe UI', size: 16, weight: 'normal' } },
                        tooltip: { callbacks: { label: (context) => `${context.dataset.label || ''}: ${Math.abs(context.parsed.y).toFixed(2)} МВт` } }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Година доби', font: { family: 'Segoe UI' } }, stacked: true },
                        y: { title: { display: true, text: 'Потужність, МВт', font: { family: 'Segoe UI' } }, stacked: true, ticks: { callback: (value) => `${value} МВт` } }
                    }
                }
            });
        }

        document.getElementById('exportBtn').addEventListener('click', () => {
            if (!lastInputs || !lastResults) { alert("Будь ласка, спочатку виконайте розрахунок."); return; }
            const inputsData = [
                { "Параметр": "Тип батареї", "Значення": lastInputs.batteryType }, { "Параметр": "Потужність системи (МВт)", "Значення": lastInputs.powerMW },
                { "Параметр": "Ємність системи (МВт·год)", "Значення": lastInputs.capacityMWh }, { "Параметр": "ККД повного циклу (%)", "Значення": lastInputs.rte },
                { "Параметр": "Глибина розряду (%)", "Значення": lastInputs.dod }, { "Параметр": "Кількість циклів на рік", "Значення": lastInputs.cyclesPerYear },
                { "Параметр": "Річна деградація ємності (%)", "Значення": lastInputs.degradationRate }, { "Параметр": "Капітальні витрати ($/кВт·год)", "Значення": lastInputs.capexPerKWh },
                { "Параметр": "Фіксовані витрати на O&M ($/кВт-рік)", "Значення": lastInputs.omPerKWYear }, { "Параметр": "Вартість енергії для зарядки ($/МВт·год)", "Значення": lastInputs.chargingCostPerMWh },
                { "Параметр": "Вартість заміни (% від CAPEX)", "Значення": lastInputs.replacementCostPercent }, { "Параметр": "Рік заміни", "Значення": lastInputs.replacementYear },
                { "Параметр": "Термін служби проєкту (Років)", "Значення": lastInputs.lifetime }, { "Параметр": "Ставка дисконтування (%)", "Значення": lastInputs.discountRate },
                { "Параметр": "Рівень інфляції (%)", "Значення": lastInputs.inflationRate }, { "Параметр": "Ціна продажу (PPA), Рік 1 ($/МВт·год)", "Значення": lastInputs.ppaPrice },
                { "Параметр": "Індексація PPA (% / рік)", "Значення": lastInputs.ppaEscalation },
            ];
            const inputs_ws = XLSX.utils.json_to_sheet(inputsData);
            const resultsData = [
                { "Метрика": "Чисті капітальні витрати", "Значення": lastResults.netCapitalCost }, { "Метрика": "ККД повного циклу", "Значення": lastResults.rte },
                { "Метрика": "Зарядка від мережі (Рік 1)", "Значення": lastResults.energyChargedY1 }, { "Метрика": "LCOE (номінальний)", "Значення": lastResults.lcoeNominal },
                { "Метрика": "LCOE (реальний)", "Значення": lastResults.lcoeReal }, { "Метрика": "Ціна PPA (Рік 1)", "Значення": lastResults.ppaY1 },
                { "Метрика": "LPPA (номінальний)", "Значення": lastResults.lppaNominal }, { "Метрика": "LPPA (реальний)", "Значення": lastResults.lppaReal },
                { "Метрика": "Чиста приведена вартість (NPV)", "Значення": lastResults.npv }, { "Метрика": "Внутрішня норма дохідності (IRR)", "Значення": lastResults.irr },
                { "Метрика": "Рік досягнення IRR (окупність)", "Значення": lastResults.paybackYear },
            ];
            const results_ws = XLSX.utils.json_to_sheet(resultsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, inputs_ws, "Вхідні дані");
            XLSX.utils.book_append_sheet(wb, results_ws, "Результати");
            XLSX.writeFile(wb, "BESS_Calculation_Results.xlsx");
        });

        // --- Navigation Logic ---
        const menuToggle = document.getElementById('menu-toggle');
        const sideMenu = document.getElementById('side-menu');
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page-content');

        menuToggle.addEventListener('click', () => {
            sideMenu.classList.toggle('open');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = e.target.getAttribute('data-target');
                
                pages.forEach(page => {
                    if (page.id === targetId) {
                        page.classList.remove('hidden');
                    } else {
                        page.classList.add('hidden');
                    }
                });
                sideMenu.classList.remove('open');
            });
        });
    </script>
</body>
</html>
